<div class="audit-timeline-container">
  <!-- Filter Bar -->
  <div class="filter-bar">
    <mat-form-field appearance="outline" class="filter-select">
      <mat-label>Filter by event type</mat-label>
      <mat-select [(ngModel)]="selectedEventType" (selectionChange)="onFilterChange()">
        <mat-option value="">All Events</mat-option>
        @for (type of eventTypes; track type) {
          <mat-option [value]="type">
            {{ getEventConfig(type).label }}
          </mat-option>
        }
      </mat-select>
    </mat-form-field>

    @if (selectedEventType) {
      <button mat-button color="primary" (click)="clearFilter()">
        <mat-icon>clear</mat-icon> Clear Filter
      </button>
    }

    <button mat-icon-button (click)="loadEvents()" [disabled]="loading"
            matTooltip="Refresh audit trail">
      <mat-icon>refresh</mat-icon>
    </button>

    <span class="event-count">
      {{ filteredEvents.length }} event{{ filteredEvents.length !== 1 ? 's' : '' }}
    </span>
  </div>

  <!-- Loading State -->
  @if (loading) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading audit trail...</p>
    </div>
  }

  <!-- Error State -->
  @if (error && !loading) {
    <div class="error-container">
      <mat-icon color="warn">error_outline</mat-icon>
      <p>{{ error }}</p>
      <button mat-button color="primary" (click)="loadEvents()">Retry</button>
    </div>
  }

  <!-- Empty State -->
  @if (!loading && !error && filteredEvents.length === 0) {
    <div class="empty-container">
      <mat-icon>history</mat-icon>
      <p>No audit events found</p>
      @if (selectedEventType) {
        <p class="hint">Try clearing the filter to see all events</p>
      }
    </div>
  }

  <!-- Timeline -->
  @if (!loading && filteredEvents.length > 0) {
    <div class="timeline">
      @for (event of filteredEvents; track event.id; let i = $index; let last = $last) {
        <div class="timeline-item">
          <div class="timeline-marker"
               [style.background-color]="getEventConfig(event.eventType).color">
            <mat-icon class="marker-icon">{{ getEventConfig(event.eventType).icon }}</mat-icon>
          </div>
          <div class="timeline-connector" [class.last]="last"></div>

          <div class="timeline-content">
            <div class="event-header">
              <span class="event-type"
                    [style.color]="getEventConfig(event.eventType).color">
                {{ getEventConfig(event.eventType).label }}
              </span>
              <span class="event-time" [matTooltip]="formatTimestamp(event.timestamp)">
                {{ formatRelativeTime(event.timestamp) }}
              </span>
            </div>

            <div class="event-description">{{ event.description }}</div>

            <div class="event-meta">
              <span class="meta-item" matTooltip="Performed by">
                <mat-icon class="meta-icon">person</mat-icon>
                {{ event.performedByName || 'System' }}
              </span>
              @if (event.performedByRole) {
                <span class="meta-item" matTooltip="Role">
                  <mat-icon class="meta-icon">badge</mat-icon>
                  {{ event.performedByRole }}
                </span>
              }
              @if (event.serviceName) {
                <span class="meta-item" matTooltip="Service">
                  <mat-icon class="meta-icon">dns</mat-icon>
                  {{ event.serviceName }}
                </span>
              }
            </div>

            <!-- State Changes -->
            @if (getStateChanges(event).length > 0) {
              <div class="state-changes">
                @for (change of getStateChanges(event); track change.key) {
                  <div class="state-change-row">
                    <span class="change-key">{{ change.key }}:</span>
                    @if (change.before !== '-') {
                      <span class="change-before">{{ change.before }}</span>
                      <mat-icon class="change-arrow">arrow_forward</mat-icon>
                    }
                    <span class="change-after">{{ change.after }}</span>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }
    </div>
  }
</div>
