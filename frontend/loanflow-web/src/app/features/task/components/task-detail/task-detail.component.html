<div class="task-detail-container">
  @if (loading) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
    </div>
  } @else if (task) {
    <!-- Header Card -->
    <mat-card class="header-card">
      <div class="header-content">
        <div class="header-left">
          <div class="task-type">
            <mat-icon class="task-icon">rate_review</mat-icon>
            <span class="task-label">{{ getTaskLabel(task.taskDefinitionKey) }}</span>
          </div>
          <div class="app-number">{{ task.applicationNumber }}</div>
          <div class="task-meta">
            <span class="meta-item">
              <mat-icon>category</mat-icon>
              {{ formatLoanType(task.loanType) }}
            </span>
            <span class="meta-item">
              <mat-icon>currency_rupee</mat-icon>
              {{ formatCurrency(task.requestedAmount) }}
            </span>
            @if (task.customerEmail) {
              <span class="meta-item">
                <mat-icon>email</mat-icon>
                {{ task.customerEmail }}
              </span>
            }
          </div>
        </div>
        <div class="header-right">
          @if (loan?.status) {
            <mat-chip [color]="getStatusColor(loan?.status)" selected class="status-chip">
              {{ getStatusLabel(loan?.status) }}
            </mat-chip>
          }
          @if (task.assignee) {
            <span class="assignee-badge">
              <mat-icon>person</mat-icon> Assigned to you
            </span>
          } @else {
            <span class="unassigned-badge">
              <mat-icon>group</mat-icon> Unclaimed
            </span>
          }
        </div>
      </div>

      <div class="header-actions">
        @if (!task.assignee) {
          <button mat-raised-button color="primary" (click)="claimTask()" [disabled]="actionLoading"
                  matTooltip="Claim this task to start working on it">
            <mat-icon>assignment_ind</mat-icon> Claim Task
          </button>
        } @else {
          <button mat-stroked-button color="warn" (click)="releaseTask()" [disabled]="actionLoading"
                  matTooltip="Release task back to the pool">
            <mat-icon>undo</mat-icon> Release Task
          </button>
        }
        <button mat-button (click)="goBack()">
          <mat-icon>arrow_back</mat-icon> Back to Inbox
        </button>
      </div>
    </mat-card>

    <!-- Detail Tabs -->
    <mat-card>
      <mat-tab-group>
        <!-- Loan Details Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">description</mat-icon>
            Loan Details
          </ng-template>
          <div class="tab-content">
            @if (loan) {
              <div class="details-grid">
                <div class="detail-item">
                  <span class="label">Loan Type</span>
                  <span class="value">{{ getLoanTypeLabel(loan.loanType) }}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Requested Amount</span>
                  <span class="value amount">{{ formatAmount(loan.requestedAmount) }}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Tenure</span>
                  <span class="value">{{ loan.tenureMonths }} months</span>
                </div>
                <div class="detail-item">
                  <span class="label">Purpose</span>
                  <span class="value">{{ loan.purpose || '-' }}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Customer</span>
                  <span class="value">{{ loan.customerName || task.customerEmail || '-' }}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Branch Code</span>
                  <span class="value">{{ loan.branchCode || '-' }}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Application Date</span>
                  <span class="value">{{ formatDate(loan.createdAt) }}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Submitted Date</span>
                  <span class="value">{{ formatDate(loan.submittedAt) }}</span>
                </div>
              </div>

              @if (loan.approvedAmount) {
                <mat-divider class="section-divider"></mat-divider>
                <h4>Approval Details</h4>
                <div class="details-grid">
                  <div class="detail-item">
                    <span class="label">Approved Amount</span>
                    <span class="value amount">{{ formatAmount(loan.approvedAmount) }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="label">Interest Rate</span>
                    <span class="value">{{ loan.interestRate || '-' }}% p.a.</span>
                  </div>
                  <div class="detail-item">
                    <span class="label">EMI Amount</span>
                    <span class="value amount">{{ formatAmount(loan.emiAmount) }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="label">Processing Fee</span>
                    <span class="value">{{ formatAmount(loan.processingFee) }}</span>
                  </div>
                </div>
              }
            } @else {
              <div class="no-data">
                <mat-icon>info</mat-icon>
                <p>Full loan details not available</p>
              </div>
            }
          </div>
        </mat-tab>

        <!-- Credit Info Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">credit_score</mat-icon>
            Credit Info
          </ng-template>
          <div class="tab-content">
            <div class="details-grid">
              <div class="detail-item">
                <span class="label">CIBIL Score</span>
                @if (task.cibilScore || loan?.cibilScore) {
                  <span class="value" [class]="getCibilClass(task.cibilScore || loan?.cibilScore)">
                    {{ task.cibilScore || loan?.cibilScore }}
                  </span>
                } @else {
                  <span class="value na">Not Available</span>
                }
              </div>
              <div class="detail-item">
                <span class="label">Risk Category</span>
                @if (task.riskCategory || loan?.riskCategory) {
                  <mat-chip [color]="getRiskColor(task.riskCategory || loan?.riskCategory || '')" selected>
                    {{ task.riskCategory || loan?.riskCategory }}
                  </mat-chip>
                } @else {
                  <span class="value na">Not Assessed</span>
                }
              </div>
              @if (loan) {
                <div class="detail-item">
                  <span class="label">Interest Rate</span>
                  @if (loan.interestRate) {
                    <span class="value">{{ loan.interestRate }}% p.a.</span>
                  } @else {
                    <span class="value na">Not Computed</span>
                  }
                </div>
                <div class="detail-item">
                  <span class="label">Processing Fee</span>
                  <span class="value">{{ formatAmount(loan.processingFee) }}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Bureau Data Source</span>
                  @if (loan.bureauDataSource) {
                    <mat-chip [color]="getBureauSourceColor(loan.bureauDataSource)" selected class="bureau-chip">
                      {{ getBureauSourceLabel(loan.bureauDataSource) }}
                    </mat-chip>
                  } @else {
                    <span class="value na">Not Pulled</span>
                  }
                </div>
                <div class="detail-item">
                  <span class="label">Bureau Pull Time</span>
                  <span class="value">{{ loan.bureauPullTimestamp ? formatDate(loan.bureauPullTimestamp) : '-' }}</span>
                </div>
              }
            </div>

            <!-- Bureau Report Expansion Panel -->
            @if (bureauReport) {
              <mat-divider class="section-divider"></mat-divider>
              <mat-accordion>
                <mat-expansion-panel>
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      <mat-icon class="panel-icon">assessment</mat-icon>
                      Bureau Report Details
                    </mat-panel-title>
                    <mat-panel-description>
                      Score: {{ bureauReport.creditScore }} | {{ bureauReport.scoreVersion }}
                    </mat-panel-description>
                  </mat-expansion-panel-header>

                  <div class="bureau-details">
                    <div class="details-grid">
                      <div class="detail-item">
                        <span class="label">Control Number</span>
                        <span class="value mono">{{ bureauReport.controlNumber }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="label">Total Active Accounts</span>
                        <span class="value">{{ bureauReport.totalActiveAccounts }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="label">Total Outstanding</span>
                        <span class="value amount">{{ formatBalance(bureauReport.totalOutstandingBalance) }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="label">DPD 90+ Accounts</span>
                        <span class="value" [class.negative-marker]="bureauReport.dpd90PlusCount > 0">
                          {{ bureauReport.dpd90PlusCount }}
                        </span>
                      </div>
                      <div class="detail-item">
                        <span class="label">Written-Off Accounts</span>
                        <span class="value" [class.negative-marker]="bureauReport.writtenOffAccounts > 0">
                          {{ bureauReport.writtenOffAccounts }}
                        </span>
                      </div>
                      <div class="detail-item">
                        <span class="label">Enquiries (30 Days)</span>
                        <span class="value">{{ bureauReport.enquiryCount30Days }}</span>
                      </div>
                    </div>

                    @if (bureauReport.scoreFactors && bureauReport.scoreFactors.length > 0) {
                      <mat-divider class="section-divider"></mat-divider>
                      <h4>Score Factors</h4>
                      <div class="score-factors">
                        @for (factor of bureauReport.scoreFactors; track factor) {
                          <mat-chip class="factor-chip">{{ factor }}</mat-chip>
                        }
                      </div>
                    }

                    @if (bureauReport.accounts && bureauReport.accounts.length > 0) {
                      <mat-divider class="section-divider"></mat-divider>
                      <h4>Account Summary ({{ bureauReport.accounts.length }})</h4>
                      <div class="account-list">
                        @for (account of bureauReport.accounts; track account.lenderName) {
                          <div class="account-card">
                            <div class="account-header">
                              <span class="lender">{{ account.lenderName }}</span>
                              <mat-chip class="account-type-chip">{{ account.accountType }}</mat-chip>
                            </div>
                            <div class="account-details">
                              <span>Balance: {{ formatBalance(account.currentBalance) }}</span>
                              @if (account.amountOverdue > 0) {
                                <span class="negative-marker">Overdue: {{ formatBalance(account.amountOverdue) }}</span>
                              }
                              <span>DPD: {{ account.dpdStatus }}</span>
                              <span>Status: {{ account.accountStatus }}</span>
                            </div>
                          </div>
                        }
                      </div>
                    }

                    @if (bureauReport.enquiries && bureauReport.enquiries.length > 0) {
                      <mat-divider class="section-divider"></mat-divider>
                      <h4>Recent Enquiries ({{ bureauReport.enquiries.length }})</h4>
                      <mat-list dense>
                        @for (enquiry of bureauReport.enquiries; track enquiry.enquiryDate) {
                          <mat-list-item>
                            <mat-icon matListItemIcon>search</mat-icon>
                            <div matListItemTitle>{{ enquiry.memberName }} — {{ enquiry.purpose }}</div>
                            <div matListItemLine>{{ enquiry.enquiryDate }} | {{ formatBalance(enquiry.amount) }}</div>
                          </mat-list-item>
                        }
                      </mat-list>
                    }
                  </div>
                </mat-expansion-panel>
              </mat-accordion>
            }

            <!-- Income Verification Section -->
            @if (loan) {
              <mat-divider class="section-divider"></mat-divider>
              <div class="income-header-row">
                <h4>
                  <mat-icon class="section-title-icon">account_balance</mat-icon>
                  Income Verification
                </h4>
                @if (!incomeReport && !loan.incomeVerified) {
                  <button mat-stroked-button color="primary" (click)="pullIncomeReport(task.customerEmail || '')"
                          [disabled]="incomeLoading" class="pull-btn">
                    @if (incomeLoading) {
                      <mat-spinner diameter="18"></mat-spinner>
                    } @else {
                      <mat-icon>verified</mat-icon> Pull Income Data
                    }
                  </button>
                }
              </div>

              <!-- Income Summary Cards -->
              @if (loan.incomeVerified || incomeReport) {
                <div class="income-summary-cards">
                  <div class="income-card">
                    <span class="income-card-label">Verified Monthly Income</span>
                    <span class="income-card-value amount">
                      {{ formatAmount(incomeReport?.verifiedMonthlyIncome || loan.verifiedMonthlyIncome) }}
                    </span>
                  </div>
                  <div class="income-card">
                    <span class="income-card-label">DTI Ratio</span>
                    <span class="income-card-value"
                          [class]="getDtiClass(incomeReport?.dtiRatio ?? loan.dtiRatio)">
                      {{ formatPercent(incomeReport?.dtiRatio ?? loan.dtiRatio) }}
                    </span>
                  </div>
                  @if (incomeReport?.incomeConsistencyScore !== undefined) {
                    <div class="income-card">
                      <span class="income-card-label">Consistency Score</span>
                      <span class="income-card-value"
                            [class]="getConsistencyClass(incomeReport?.incomeConsistencyScore)">
                        {{ incomeReport?.incomeConsistencyScore }}%
                      </span>
                    </div>
                  }
                  <div class="income-card">
                    <span class="income-card-label">Data Source</span>
                    <mat-chip [color]="getIncomeSourceColor(incomeReport?.dataSource || loan.incomeDataSource)" selected class="bureau-chip">
                      {{ getIncomeSourceLabel(incomeReport?.dataSource || loan.incomeDataSource) }}
                    </mat-chip>
                  </div>
                </div>

                <!-- Warning Flags -->
                @if (incomeReport && incomeReport.flags && incomeReport.flags.length > 0) {
                  <div class="income-flags">
                    @for (flag of incomeReport!.flags; track flag) {
                      <mat-chip color="warn" selected class="flag-chip">
                        <mat-icon class="flag-icon">warning</mat-icon>
                        {{ flag }}
                      </mat-chip>
                    }
                  </div>
                }

                <!-- Income Details Expansion Panel -->
                @if (incomeReport) {
                  <mat-accordion class="income-accordion">
                    <!-- ITR Data -->
                    @if (incomeReport.itrData) {
                      <mat-expansion-panel>
                        <mat-expansion-panel-header>
                          <mat-panel-title>
                            <mat-icon class="panel-icon">receipt_long</mat-icon>
                            ITR Data
                          </mat-panel-title>
                          <mat-panel-description>
                            AY {{ incomeReport.itrData.assessmentYear }} | {{ incomeReport.itrData.itrFormType }}
                          </mat-panel-description>
                        </mat-expansion-panel-header>
                        <div class="details-grid">
                          <div class="detail-item">
                            <span class="label">Gross Total Income</span>
                            <span class="value amount">{{ formatAmount(incomeReport.itrData.grossTotalIncome) }}</span>
                          </div>
                          <div class="detail-item">
                            <span class="label">Salary Income</span>
                            <span class="value">{{ formatAmount(incomeReport.itrData.salaryIncome) }}</span>
                          </div>
                          <div class="detail-item">
                            <span class="label">Business Income</span>
                            <span class="value">{{ formatAmount(incomeReport.itrData.businessIncome) }}</span>
                          </div>
                          <div class="detail-item">
                            <span class="label">ITR Form</span>
                            <span class="value mono">{{ incomeReport.itrData.itrFormType }}</span>
                          </div>
                          <div class="detail-item">
                            <span class="label">Assessment Year</span>
                            <span class="value">{{ incomeReport.itrData.assessmentYear }}</span>
                          </div>
                          <div class="detail-item">
                            <span class="label">Filed On Time</span>
                            <span class="value" [class.cibil-good]="incomeReport.itrData.filedOnTime"
                                  [class.cibil-poor]="!incomeReport.itrData.filedOnTime">
                              {{ incomeReport.itrData.filedOnTime ? 'Yes' : 'No' }}
                            </span>
                          </div>
                        </div>
                      </mat-expansion-panel>
                    }

                    <!-- GST Data -->
                    @if (incomeReport.gstData) {
                      <mat-expansion-panel>
                        <mat-expansion-panel-header>
                          <mat-panel-title>
                            <mat-icon class="panel-icon">store</mat-icon>
                            GST Data
                          </mat-panel-title>
                          <mat-panel-description>
                            {{ incomeReport.gstData.gstin }} |
                            <mat-chip [color]="getGstComplianceColor(incomeReport.gstData.complianceRating)" selected class="bureau-chip">
                              {{ incomeReport.gstData.complianceRating }}
                            </mat-chip>
                          </mat-panel-description>
                        </mat-expansion-panel-header>
                        <div class="details-grid">
                          <div class="detail-item">
                            <span class="label">GSTIN</span>
                            <span class="value mono">{{ incomeReport.gstData.gstin }}</span>
                          </div>
                          <div class="detail-item">
                            <span class="label">Annual Turnover</span>
                            <span class="value amount">{{ formatAmount(incomeReport.gstData.annualTurnover) }}</span>
                          </div>
                          <div class="detail-item">
                            <span class="label">Compliance Rating</span>
                            <mat-chip [color]="getGstComplianceColor(incomeReport.gstData.complianceRating)" selected>
                              {{ incomeReport.gstData.complianceRating }}
                            </mat-chip>
                          </div>
                          <div class="detail-item">
                            <span class="label">Filing Count</span>
                            <span class="value">{{ incomeReport.gstData.filingCount }}</span>
                          </div>
                          <div class="detail-item">
                            <span class="label">Status</span>
                            <span class="value" [class.cibil-good]="incomeReport.gstData.active"
                                  [class.cibil-poor]="!incomeReport.gstData.active">
                              {{ incomeReport.gstData.active ? 'Active' : 'Inactive' }}
                            </span>
                          </div>
                        </div>
                      </mat-expansion-panel>
                    }

                    <!-- Bank Statement Data -->
                    @if (incomeReport.bankStatementData) {
                      <mat-expansion-panel>
                        <mat-expansion-panel-header>
                          <mat-panel-title>
                            <mat-icon class="panel-icon">account_balance_wallet</mat-icon>
                            Bank Statement Analysis
                          </mat-panel-title>
                          <mat-panel-description>
                            {{ incomeReport.bankStatementData.monthsAnalyzed }} months analyzed
                          </mat-panel-description>
                        </mat-expansion-panel-header>
                        <div class="details-grid">
                          <div class="detail-item">
                            <span class="label">Avg Monthly Balance</span>
                            <span class="value amount">{{ formatAmount(incomeReport.bankStatementData.avgMonthlyBalance) }}</span>
                          </div>
                          <div class="detail-item">
                            <span class="label">Avg Monthly Credits</span>
                            <span class="value amount">{{ formatAmount(incomeReport.bankStatementData.avgMonthlyCredits) }}</span>
                          </div>
                          <div class="detail-item">
                            <span class="label">Cheque Bounces</span>
                            <span class="value" [class.negative-marker]="incomeReport.bankStatementData.bounceCount > 3">
                              {{ incomeReport.bankStatementData.bounceCount }}
                            </span>
                          </div>
                          <div class="detail-item">
                            <span class="label">Min Balance</span>
                            <span class="value">{{ formatAmount(incomeReport.bankStatementData.minBalance) }}</span>
                          </div>
                          <div class="detail-item">
                            <span class="label">Max Balance</span>
                            <span class="value">{{ formatAmount(incomeReport.bankStatementData.maxBalance) }}</span>
                          </div>
                          <div class="detail-item">
                            <span class="label">Months Analyzed</span>
                            <span class="value">{{ incomeReport.bankStatementData.monthsAnalyzed }}</span>
                          </div>
                        </div>

                        @if (incomeReport.bankStatementData.monthlyBalances && incomeReport.bankStatementData.monthlyBalances.length > 0) {
                          <mat-divider class="section-divider"></mat-divider>
                          <h4>Monthly Balance Trend</h4>
                          <div class="balance-trend">
                            @for (balance of incomeReport.bankStatementData.monthlyBalances; track $index) {
                              <div class="balance-bar-container">
                                <span class="balance-value">{{ formatBalance(balance) }}</span>
                                <div class="balance-bar"
                                     [style.height.%]="(balance / (incomeReport.bankStatementData.maxBalance || 1)) * 100">
                                </div>
                                <span class="balance-month">M{{ $index + 1 }}</span>
                              </div>
                            }
                          </div>
                        }
                      </mat-expansion-panel>
                    }
                  </mat-accordion>
                }
              } @else {
                <div class="no-income-data">
                  <mat-icon>verified_user</mat-icon>
                  <p>Income verification not yet performed</p>
                </div>
              }
            }

            <!-- Credit Memo (printable summary) -->
            @if (loan) {
              <mat-divider class="section-divider"></mat-divider>
              <app-credit-memo [task]="task" [loan]="loan"></app-credit-memo>
            }
          </div>
        </mat-tab>

        <!-- Decision Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">gavel</mat-icon>
            Decision
          </ng-template>
          <div class="tab-content">
            @if (task.assignee) {
              <app-decision-panel
                [task]="task"
                [loan]="loan"
                [loading]="actionLoading"
                (decisionSubmitted)="onDecisionSubmitted($event)">
              </app-decision-panel>
            } @else {
              <div class="claim-prompt">
                <mat-icon>lock</mat-icon>
                <h3>Claim Required</h3>
                <p>You must claim this task before making a decision.</p>
                <button mat-raised-button color="primary" (click)="claimTask()" [disabled]="actionLoading">
                  <mat-icon>assignment_ind</mat-icon> Claim Task
                </button>
              </div>
            }
          </div>
        </mat-tab>

        <!-- Documents Tab (US-021: Enhanced with Document Panel) -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">folder</mat-icon>
            Documents
          </ng-template>
          <div class="tab-content">
            <app-document-panel
              [applicationId]="loan?.id"
              [loanType]="loan?.loanType">
            </app-document-panel>
          </div>
        </mat-tab>

        <!-- Timeline Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">timeline</mat-icon>
            Timeline
          </ng-template>
          <div class="tab-content">
            <mat-list>
              @if (loan?.createdAt) {
                <mat-list-item>
                  <mat-icon matListItemIcon>add_circle</mat-icon>
                  <div matListItemTitle>Application Created</div>
                  <div matListItemLine>{{ formatDate(loan?.createdAt) }}</div>
                </mat-list-item>
                <mat-divider></mat-divider>
              }
              @if (loan?.submittedAt) {
                <mat-list-item>
                  <mat-icon matListItemIcon>send</mat-icon>
                  <div matListItemTitle>Submitted for Processing</div>
                  <div matListItemLine>{{ formatDate(loan?.submittedAt) }}</div>
                </mat-list-item>
                <mat-divider></mat-divider>
              }
              <mat-list-item>
                <mat-icon matListItemIcon>assignment</mat-icon>
                <div matListItemTitle>Task Created: {{ getTaskLabel(task.taskDefinitionKey) }}</div>
                <div matListItemLine>{{ formatDate(task.createdAt) }}</div>
              </mat-list-item>
            </mat-list>

            @if (loan?.workflowHistory?.length) {
              <mat-divider class="section-divider"></mat-divider>
              <h4>Workflow History</h4>
              <mat-list>
                @for (history of loan!.workflowHistory!; track history.timestamp) {
                  <mat-list-item>
                    <mat-icon matListItemIcon>history</mat-icon>
                    <div matListItemTitle>{{ history.fromStage }} → {{ history.toStage }}</div>
                    <div matListItemLine>{{ history.action }} by {{ history.performedBy }} - {{ formatDate(history.timestamp) }}</div>
                  </mat-list-item>
                  <mat-divider></mat-divider>
                }
              </mat-list>
            }
          </div>
        </mat-tab>
      </mat-tab-group>
    </mat-card>
  }
</div>
